# 워크플로우의 전체 이름을 "CI/CD Docker to EC2"로 정했음.
name: CI/CD Docker to EC2

# 언제 이 워크플로우를 실행할지 정하는 부분임.
on:
  push:
    # "main" 브랜치에 코드가 push 될 때마다 실행될 거임.
    branches: [ "main" ]

# 워크플로우가 해야 할 작업(job)들을 정의함.
jobs:
  # "build-and-deploy"라는 이름의 작업을 하나 만들었음.
  build-and-deploy:
    # 이 작업은 GitHub이 제공하는 최신 우분투 가상머신에서 돌아감.
    runs-on: ubuntu-latest
    # 이 작업이 수행할 단계(step)들을 순서대로 나열함.
    steps:
      # 1단계: 코드 내려받기
      - name: Checkout
        # GitHub 저장소에 있는 코드를 가상머신으로 복사해오는 액션을 사용함.
        uses: actions/checkout@v3

      # 2단계: 자바(JDK) 설치
      - name: Set up JDK 17
        # 가상머신에 특정 버전의 자바를 설치하는 액션을 사용함.
        uses: actions/setup-java@v3
        with:
          # 자바 버전을 '17'로 지정함.
          java-version: '17'
          # 'temurin'이라는 배포판을 사용함.
          distribution: 'temurin'

      # 3단계: gradlew 파일에 실행 권한 주기
      - name: Grant execute permission for gradlew
        # gradlew 파일이 실행될 수 있도록 권한을 변경함. 리눅스 환경이라 필수임.
        run: chmod +x gradlew

      # 4단계: 프로젝트 빌드
      - name: Build with Gradle
        # gradlew 명령어로 스프링 부트 프로젝트를 빌드함. 이걸 해야 .jar 파일이 생김.
        run: ./gradlew build

      # 5단계: 도커 빌드 환경 설정
      - name: Set up Docker Buildx
        # 도커 이미지를 효율적으로 빌드하기 위한 Buildx라는 툴을 설정함.
        uses: docker/setup-buildx-action@v2

      # 6단계: 도커 허브 로그인
      - name: Login to Docker Hub
        # 도커 이미지를 올릴 Docker Hub에 로그인하는 액션을 사용함.
        uses: docker/login-action@v2
        with:
          # 아이디는 GitHub Secrets에 저장된 DOCKERHUB_USERNAME 값을 사용함.
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          # 비밀번호는 GitHub Secrets에 저장된 DOCKERHUB_TOKEN 값을 사용함.
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 7단계: 도커 이미지 빌드 및 푸시
      - name: Build and push
        # Dockerfile을 이용해 이미지를 만들고 Docker Hub에 올리는 액션을 사용함.
        uses: docker/build-push-action@v4
        with:
          # 현재 폴더(.)에 있는 Dockerfile을 사용해서 빌드함.
          context: .
          # 빌드 성공하면 바로 Docker Hub로 푸시(업로드)함.
          push: true
          # 이미지 이름은 "아이디/my-spring-app:latest" 형식으로 지정함.
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-spring-app:latest

      # 8단계: EC2 서버에 배포
      - name: Deploy to EC2
        # SSH를 통해 EC2에 접속해서 명령어를 실행하는 액션을 사용함.
        uses: appleboy/ssh-action@master
        with:
          # 접속할 EC2 서버의 IP 주소. Secrets에서 값을 가져옴.
          host: ${{ secrets.EC2_HOST }}
          # EC2 서버의 사용자 이름 (지금은 ubuntu). Secrets에서 값을 가져옴.
          username: ${{ secrets.EC2_USERNAME }}
          # EC2 접속에 필요한 .pem 키. Secrets에서 값을 가져옴.
          key: ${{ secrets.EC2_SSH_KEY }}
          # EC2 서버에 접속해서 아래 스크립트를 순서대로 실행시킬 거임.
          script: |
          
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/my-spring-app:latest
            docker stop my-app || true
            docker rm my-app || true
            docker run -d -p 8080:8080 --name my-app \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/my-spring-app:latest